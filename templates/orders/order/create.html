{% extends 'base.html' %}

{% block title %}Checkout - {{ site_settings.site_name }}{% endblock %}

{% block content %}
{% load i18n %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8 text-cannabis-dark font-heading">
        <i class="fas fa-cannabis mr-2 text-cannabis-green"></i>{% trans "Complete Your Order" %}
    </h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Order Form - Left Column -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-cannabis-light">
            <!-- Age Verification -->
            <div class="bg-cannabis-light/20 p-4 rounded-lg mb-6 border border-cannabis-light">
                <div class="flex items-start">
                    <input type="checkbox" id="age-verify" required 
                           class="mt-1 mr-3 h-5 w-5 text-cannabis-green focus:ring-cannabis-green border-cannabis-green rounded">
                    <label for="age-verify" class="text-sm text-gray-700">
                        {% trans "I confirm that I am 21 years of age or older and agree to the" %} 
                        <a href="#" class="text-cannabis-green hover:underline font-medium">{% trans "Terms of Service" %}</a>
                    </label>
                </div>
            </div>
            
            <form method="post" class="space-y-6">
                {% csrf_token %}
                
                <!-- Hidden fields -->
                <input type="hidden" name="payment_status" value="pending">
                <input type="hidden" name="status" value="pending">
                <input type="hidden" name="total_amount" value="{{ cart.get_total_price }}">
                
                <!-- Billing Details Section -->
                <div class="space-y-6">
                    <h2 class="text-xl font-semibold text-cannabis-dark border-b pb-2 flex items-center">
                        <i class="fas fa-user-circle mr-2 text-cannabis-green"></i>
                        {% trans "Billing Information" %}
                    </h2>
                    
                    <!-- Name Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="first_name" class="block text-sm font-medium text-gray-700 mb-1">
                                {% trans "First Name" %} <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="first_name" name="first_name" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cannabis-green focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1">
                                {% trans "Last Name" %} <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="last_name" name="last_name" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cannabis-green focus:border-transparent">
                        </div>
                    </div>
                    
                    <!-- Contact Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                                {% trans "Email" %} <span class="text-red-500">*</span>
                            </label>
                            <input type="email" id="email" name="email" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cannabis-green focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                                {% trans "Phone" %}
                            </label>
                            <input type="tel" id="phone" name="phone"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cannabis-green focus:border-transparent">
                        </div>
                    </div>
                    
                    <!-- Address Section -->
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">
                            {% trans "Street Address" %} <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="address" name="address" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cannabis-green focus:border-transparent">
                    </div>
                    
                    <!-- City/Postal/Country -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="postal_code" class="block text-sm font-medium text-gray-700 mb-1">
                                {% trans "Postal Code" %} <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="postal_code" name="postal_code" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cannabis-green focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="city" class="block text-sm font-medium text-gray-700 mb-1">
                                {% trans "City" %} <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="city" name="city" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cannabis-green focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="country" class="block text-sm font-medium text-gray-700 mb-1">
                                {% trans "Country" %} <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="country" name="country" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cannabis-green focus:border-transparent">
                        </div>
                    </div>
                </div>
                
                <!-- Payment Section -->
                <div class="space-y-6">
                    <h2 class="text-xl font-semibold text-cannabis-dark border-b pb-2 flex items-center">
                        <i class="fas fa-wallet mr-2 text-cannabis-green"></i>
                        {% trans "Payment Method" %}
                    </h2>
                    
                    <!-- Payment Options -->
                    <div class="space-y-4">
                        <!-- Bank Transfer -->
                        <div class="relative">
                            <input class="sr-only peer" required type="radio" name="payment_method" id="bank-transfer" value="bank_transfer">
                            <label for="bank-transfer" class="flex p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-cannabis-green peer-checked:border-cannabis-green peer-checked:bg-cannabis-light/20">
                                <div class="flex items-center mr-4">
                                    <i class="fas fa-university text-2xl text-cannabis-green"></i>
                                </div>
                                <div>
                                    <h3 class="font-medium text-gray-900">{% trans "Bank Transfer" %}</h3>
                                    <p class="text-sm text-gray-500">{% trans "You'll receive payment details after order" %}</p>
                                </div>
                                <i class="fas fa-check-circle ml-auto text-xl text-cannabis-green invisible peer-checked:visible"></i>
                            </label>
                            <div id="bank-transfer-info" class="bg-cannabis-light/10 p-4 mt-2 rounded-lg hidden">
                                <p class="text-red-500 font-medium mb-2">{% trans "Do not order if you don't intend to pay." %}</p>
                                <p>{% trans "Click Place Order and you'll receive an email with details, order number and our bank information for transfer." %}</p>
                                <p>{% trans "Use the order number as reference for the transfer." %}</p>
                                <p>{% trans "Order will be shipped upon receipt of payment." %}</p>
                            </div>
                        </div>
                        
                        <!-- Cryptocurrency -->
                        <div class="relative">
                            <input class="sr-only peer" required type="radio" name="payment_method" id="cryptocurrency" value="cryptocurrency">
                            <label for="cryptocurrency" class="flex p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-cannabis-green peer-checked:border-cannabis-green peer-checked:bg-cannabis-light/20">
                                <div class="flex items-center mr-4">
                                    <i class="fab fa-bitcoin text-2xl text-cannabis-green"></i>
                                </div>
                                <div>
                                    <h3 class="font-medium text-gray-900">{% trans "Cryptocurrency" %}</h3>
                                    <p class="text-sm text-gray-500">{% trans "BTC, LTC and other major cryptos" %}</p>
                                </div>
                                <i class="fas fa-check-circle ml-auto text-xl text-cannabis-green invisible peer-checked:visible"></i>
                            </label>
                            <div id="cryptocurrency-info" class="bg-cannabis-light/10 p-4 mt-2 rounded-lg hidden">
                                <div class="mb-3">
                                    <p class="text-sm font-medium mb-1">BTC Address:</p>
                                    <div class="flex items-center bg-white p-2 rounded border border-gray-200">
                                        <code class="text-xs mr-2">bc1qwnv2uh7ppqdj8qvntl8yneadx9vjjwm2dy5g3l</code>
                                        <span onclick="copyToClipboard('bc1qwnv2uh7ppqdj8qvntl8yneadx9vjjwm2dy5g3l')" 
                                                class="ml-auto text-cannabis-green hover:text-cannabis-dark">
                                            <i class="fas fa-copy"></i>
                                        </span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Bitcoin Network</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium mb-1">USDT Address:</p>
                                    <div class="flex items-center bg-white p-2 rounded border border-gray-200">
                                        <code class="text-xs mr-2">TRYPQ1taiCUzgYNkkcVsEDGZrtALUKbE1j</code>
                                        <span onclick="copyToClipboard('TRYPQ1taiCUzgYNkkcVsEDGZrtALUKbE1j')" 
                                                class="ml-auto text-cannabis-green hover:text-cannabis-dark">
                                            <i class="fas fa-copy"></i>
                                        </span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">USDT Network</p>
                                </div>
                                <a href="{% url 'pages:crypto_guide' %}" class="inline-block mt-2 text-sm text-cannabis-green hover:underline">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    {% trans "How to pay with crypto" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Medical Info -->
                <div class="bg-cannabis-light/10 p-4 rounded-lg border border-cannabis-light">
                    <h3 class="font-semibold text-cannabis-dark mb-2 flex items-center">
                        <i class="fas fa-heartbeat mr-2 text-cannabis-green"></i>
                        {% trans "Responsible Use" %}
                    </h3>
                    <div class="text-sm text-gray-700 space-y-2">
                        <p><strong>{% trans "Dosage:" %}</strong> {% trans "Start with low doses (2.5-5mg THC). Effects may take 30-90 minutes when ingested." %}</p>
                        <p><strong>{% trans "Storage:" %}</strong> {% trans "Keep in a cool, dark place. Store securely away from children and pets." %}</p>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" class="w-full bg-cannabis-green hover:bg-cannabis-dark text-white py-3 px-6 rounded-lg font-semibold text-lg transition duration-300 flex items-center justify-center">
                    <i class="fas fa-lock mr-2"></i>
                    {% trans "Place Secure Order" %}
                </button>
            </form>
        </div>
        
        <!-- Order Summary - Right Column -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-cannabis-light">
            <h2 class="text-xl font-semibold text-cannabis-dark mb-6 flex items-center">
                <i class="fas fa-receipt mr-2 text-cannabis-green"></i>
                {% trans "Order Summary" %}
            </h2>
            
            <!-- Cart Items -->
            <div class="space-y-4 mb-6">
                {% for item in cart_items %}
                <div class="py-3 border-b border-cannabis-light">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start">
                            {% if item.product.image %}
                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" 
                                 class="w-16 h-16 object-cover rounded-lg mr-3 border border-cannabis-light">
                            {% else %}
                            <div class="w-16 h-16 bg-gray-100 rounded-lg mr-3 flex items-center justify-center border border-cannabis-light">
                                <i class="fas fa-cannabis text-gray-400 text-xl"></i>
                            </div>
                            {% endif %}
                            <div>
                                <h4 class="font-medium text-cannabis-dark">{{ item.product.name }}</h4>
                                <div class="flex flex-wrap items-center gap-2 mt-1">
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                                        {% trans "Qty:" %} {{ item.quantity }} × {{ item.weight }}g
                                    </span>
                                    {% if item.discount_percentage > 0 %}
                                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
                                        {{ item.discount_percentage }}% OFF
                                    </span>
                                    {% endif %}
                                    {% if item.product.thc_content %}
                                    <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">THC: {{ item.product.thc_content }}%</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            {% if item.discount_percentage > 0 %}
                            <span class="text-xs text-gray-400 line-through">€{{ item.base_price|floatformat:2 }}</span>
                            {% endif %}
                            <span class="font-semibold text-cannabis-dark block">€{{ item.unit_price|floatformat:2 }}/g</span>
                            <span class="text-sm text-gray-600">= €{{ item.total_price|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Order Totals -->
            <div class="space-y-3 mb-6">
                <div class="flex justify-between text-gray-700">
                    <span>{% trans "Subtotal" %}</span>
                    <span>€{{ total_price_withouth_discount|floatformat:2 }}</span>
                </div>
                
                {% if total_discount > 0 %}
                <div class="flex justify-between text-green-600">
                    <span>{% trans "Discounts" %}</span>
                    <span>-€{{ total_discount|floatformat:2 }}</span>
                </div>
                {% endif %}
                
                <div class="flex justify-between text-gray-700">
                    <span>{% trans "Shipping" %}</span>
                    <span class="text-cannabis-green">{% trans "Free" %}</span>
                </div>
                
                <div class="border-t border-cannabis-light pt-3">
                    <div class="flex justify-between text-lg font-bold">
                        <span class="text-cannabis-dark">{% trans "Total" %}</span>
                        <span class="text-cannabis-green">€{{ total_price|floatformat:2 }}</span>
                    </div>
                </div>
                
                {% if total_discount > 0 %}
                <div class="text-sm text-green-600 text-right">
                    <i class="fas fa-tag mr-1"></i> {% trans "You saved" %} €{{ total_discount|floatformat:2 }}
                </div>
                {% endif %}
            </div>
            
            <!-- Weight Summary -->
            <div class="bg-cannabis-light/10 p-4 rounded-lg border border-cannabis-light mb-6">
                <h3 class="font-semibold text-cannabis-dark mb-2 flex items-center">
                    <i class="fas fa-weight-hanging mr-2 text-cannabis-green"></i>
                    {% trans "Total Weight" %}
                </h3>
                <p class="text-sm">
                    {% trans "Your order contains" %} <strong>{{ total_weight }}g</strong> {% trans "of premium cannabis products" %}.
                </p>
            </div>
            
            <!-- Delivery Info -->
            <div class="bg-cannabis-light/10 p-4 rounded-lg border border-cannabis-light mb-6">
                <h3 class="font-semibold text-cannabis-dark mb-2 flex items-center">
                    <i class="fas fa-truck mr-2 text-cannabis-green"></i>
                    {% trans "Delivery Information" %}
                </h3>
                <ul class="text-sm text-gray-700 space-y-1 list-disc pl-5">
                    <li>{% trans "Discreet packaging for all orders" %}</li>
                    <li>{% trans "Adult signature required upon delivery" %}</li>
                    <li>{% trans "No returns on cannabis products" %}</li>
                    <li>{% trans "Estimated delivery: 2-5 business days" %}</li>
                </ul>
            </div>
            
            <!-- Disclaimer -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-exclamation-triangle mr-2 text-yellow-600"></i>
                    <strong>{% trans "Medical Disclaimer:" %}</strong> 
                    {% trans "These products are not intended to diagnose, treat, cure or prevent any disease. Consult your healthcare provider before use." %}
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Show payment method details when selected
document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
        // Hide all info sections
        document.querySelectorAll('[id$="-info"]').forEach(el => {
            el.classList.add('hidden');
        });
        
        // Show selected payment method info
        const infoId = this.value.replace('_', '-') + '-info';
        const infoElement = document.getElementById(infoId);
        if (infoElement) {
            infoElement.classList.remove('hidden');
        }
    });
});

// Copy to clipboard function
function fallbackCopyToClipboard(text) {
    const textarea = document.createElement("textarea");
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand("copy");
    document.body.removeChild(textarea);
}

function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            showTooltip("{% trans 'Address copied to clipboard!' %}");
        }).catch(() => {
            fallbackCopyToClipboard(text);
            showTooltip("{% trans 'Address copied to clipboard!' %}");
        });
    } else {
        fallbackCopyToClipboard(text);
        showTooltip("{% trans 'Address copied to clipboard!' %}");
    }
}

function showTooltip(message) {
    const tooltip = document.createElement('div');
    tooltip.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded text-sm';
    tooltip.textContent = message;
    document.body.appendChild(tooltip);

    setTimeout(() => {
        tooltip.remove();
    }, 2000);
}

// Age verification for form submission
document.querySelector('form').addEventListener('submit', function(e) {
    if (!document.getElementById('age-verify').checked) {
        e.preventDefault();
        alert('{% trans "You must confirm you are 21+ to place an order" %}');
    }
});
</script>
{% endblock %}